{"ast":null,"code":"\"use strict\";var _interopRequireDefault=require(\"@babel/runtime/helpers/interopRequireDefault\");var _regenerator=_interopRequireDefault(require(\"@babel/runtime/regenerator\"));var _slicedToArray2=_interopRequireDefault(require(\"@babel/runtime/helpers/slicedToArray\"));var _extends2=_interopRequireDefault(require(\"@babel/runtime/helpers/extends\"));var _classCallCheck2=_interopRequireDefault(require(\"@babel/runtime/helpers/classCallCheck\"));var _createClass2=_interopRequireDefault(require(\"@babel/runtime/helpers/createClass\"));var __importDefault=void 0&&(void 0).__importDefault||function(mod){return mod&&mod.__esModule?mod:{\"default\":mod};};Object.defineProperty(exports,\"__esModule\",{value:true});var url_1=require(\"url\");var mitt_1=__importDefault(require(\"../mitt\"));var utils_1=require(\"../utils\");var rewrite_url_for_export_1=require(\"./rewrite-url-for-export\");var route_matcher_1=require(\"./utils/route-matcher\");var route_regex_1=require(\"./utils/route-regex\");var is_dynamic_1=require(\"./utils/is-dynamic\");function toRoute(path){return path.replace(/\\/$/,'')||'/';}var Router=function(){function Router(pathname,query,as,_ref){var _this=this;var initialProps=_ref.initialProps,pageLoader=_ref.pageLoader,App=_ref.App,wrapApp=_ref.wrapApp,Component=_ref.Component,err=_ref.err,subscription=_ref.subscription;(0,_classCallCheck2.default)(this,Router);this.onPopState=function(e){if(!e.state){var _pathname=_this.pathname,_query=_this.query;_this.changeState('replaceState',utils_1.formatWithValidation({pathname:_pathname,query:_query}),utils_1.getURL());return;}if(e.state.options&&e.state.options.fromExternal){return;}if(_this._bps&&!_this._bps(e.state)){return;}var _e$state=e.state,url=_e$state.url,as=_e$state.as,options=_e$state.options;if(process.env.NODE_ENV!=='production'){if(typeof url==='undefined'||typeof as==='undefined'){console.warn('`popstate` event triggered but `event.state` did not have `url` or `as` https://err.sh/zeit/next.js/popstate-state-empty');}}_this.replace(url,as,options);};this.route=toRoute(pathname);this.components={};if(pathname!=='/_error'){this.components[this.route]={Component:Component,props:initialProps,err:err};}this.components['/_app']={Component:App};this.events=Router.events;this.pageLoader=pageLoader;this.pathname=pathname;this.query=query;this.asPath=is_dynamic_1.isDynamicRoute(pathname)&&__NEXT_DATA__.nextExport?pathname:as;this.sub=subscription;this.clc=null;this._wrapApp=wrapApp;if(true){this.changeState('replaceState',utils_1.formatWithValidation({pathname:pathname,query:query}),as);window.addEventListener('popstate',this.onPopState);window.addEventListener('unload',function(){if(history.state){var _history$state=history.state,url=_history$state.url,_as2=_history$state.as,options=_history$state.options;_this.changeState('replaceState',url,_as2,(0,_extends2.default)({},options,{fromExternal:true}));}});}}(0,_createClass2.default)(Router,[{key:\"update\",value:function update(route,mod){var Component=mod.default||mod;var data=this.components[route];if(!data){throw new Error(\"Cannot update unavailable route: \"+route);}var newData=(0,_extends2.default)({},data,{Component:Component});this.components[route]=newData;if(route==='/_app'){this.notify(this.components[this.route]);return;}if(route===this.route){this.notify(newData);}}},{key:\"reload\",value:function reload(){window.location.reload();}},{key:\"back\",value:function back(){window.history.back();}},{key:\"push\",value:function push(url){var as=arguments.length>1&&arguments[1]!==undefined?arguments[1]:url;var options=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{};return this.change('pushState',url,as,options);}},{key:\"replace\",value:function replace(url){var as=arguments.length>1&&arguments[1]!==undefined?arguments[1]:url;var options=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{};return this.change('replaceState',url,as,options);}},{key:\"change\",value:function change(method,_url,_as,options){var _this2=this;return new Promise(function(resolve,reject){if(utils_1.SUPPORTS_PERFORMANCE_USER_TIMING){performance.mark('routeChange');}var url=typeof _url==='object'?utils_1.formatWithValidation(_url):_url;var as=typeof _as==='object'?utils_1.formatWithValidation(_as):_as;if(process.env.__NEXT_EXPORT_TRAILING_SLASH){if(__NEXT_DATA__.nextExport){as=rewrite_url_for_export_1.rewriteUrlForNextExport(as);}}_this2.abortComponentLoad(as);if(!options._h&&_this2.onlyAHashChange(as)){_this2.asPath=as;Router.events.emit('hashChangeStart',as);_this2.changeState(method,url,as);_this2.scrollToHash(as);Router.events.emit('hashChangeComplete',as);return resolve(true);}var _url_1$parse=url_1.parse(url,true),pathname=_url_1$parse.pathname,query=_url_1$parse.query,protocol=_url_1$parse.protocol;if(!pathname||protocol){if(process.env.NODE_ENV!=='production'){throw new Error(\"Invalid href passed to router: \"+url+\" https://err.sh/zeit/next.js/invalid-href-passed\");}return resolve(false);}if(!_this2.urlIsNew(as)){method='replaceState';}var route=toRoute(pathname);var _options$shallow=options.shallow,shallow=_options$shallow===void 0?false:_options$shallow;if(is_dynamic_1.isDynamicRoute(route)){var _url_1$parse2=url_1.parse(as),asPathname=_url_1$parse2.pathname;var rr=route_regex_1.getRouteRegex(route);var routeMatch=route_matcher_1.getRouteMatcher(rr)(asPathname);if(!routeMatch){console.error('The provided `as` value is incompatible with the `href` value. This is invalid. https://err.sh/zeit/next.js/incompatible-href-as');return resolve(false);}(0,_extends2.default)(query,routeMatch);}Router.events.emit('routeChangeStart',as);_this2.getRouteInfo(route,pathname,query,as,shallow).then(function(routeInfo){var error=routeInfo.error;if(error&&error.cancelled){return resolve(false);}Router.events.emit('beforeHistoryChange',as);_this2.changeState(method,url,as,options);var hash=window.location.hash.substring(1);if(process.env.NODE_ENV!=='production'){var appComp=_this2.components['/_app'].Component;window.next.isPrerendered=appComp.getInitialProps===appComp.origGetInitialProps&&!routeInfo.Component.getInitialProps;}_this2.set(route,pathname,query,as,(0,_extends2.default)({},routeInfo,{hash:hash}));if(error){Router.events.emit('routeChangeError',error,as);throw error;}Router.events.emit('routeChangeComplete',as);return resolve(true);},reject);});}},{key:\"changeState\",value:function changeState(method,url,as){var options=arguments.length>3&&arguments[3]!==undefined?arguments[3]:{};if(process.env.NODE_ENV!=='production'){if(typeof window.history==='undefined'){console.error(\"Warning: window.history is not available.\");return;}if(typeof window.history[method]==='undefined'){console.error(\"Warning: window.history.\"+method+\" is not available\");return;}}if(method!=='pushState'||utils_1.getURL()!==as){window.history[method]({url:url,as:as,options:options},null,as);}}},{key:\"getRouteInfo\",value:function getRouteInfo(route,pathname,query,as){var _this3=this;var shallow=arguments.length>4&&arguments[4]!==undefined?arguments[4]:false;var cachedRouteInfo=this.components[route];if(shallow&&cachedRouteInfo&&this.route===route){return Promise.resolve(cachedRouteInfo);}return new Promise(function(resolve,reject){if(cachedRouteInfo){return resolve(cachedRouteInfo);}_this3.fetchComponent(route).then(function(Component){return resolve({Component:Component});},reject);}).then(function(routeInfo){var Component=routeInfo.Component;if(process.env.NODE_ENV!=='production'){var _require=require('react-is'),isValidElementType=_require.isValidElementType;if(!isValidElementType(Component)){throw new Error(\"The default export is not a React Component in page: \\\"\"+pathname+\"\\\"\");}}return new Promise(function(resolve,reject){_this3.getInitialProps(Component,{pathname:pathname,query:query,asPath:as}).then(function(props){routeInfo.props=props;_this3.components[route]=routeInfo;resolve(routeInfo);},reject);});}).catch(function(err){return new Promise(function(resolve){if(err.code==='PAGE_LOAD_ERROR'){window.location.href=as;err.cancelled=true;return resolve({error:err});}if(err.cancelled){return resolve({error:err});}resolve(_this3.fetchComponent('/_error').then(function(Component){var routeInfo={Component:Component,err:err};return new Promise(function(resolve){_this3.getInitialProps(Component,{err:err,pathname:pathname,query:query}).then(function(props){routeInfo.props=props;routeInfo.error=err;resolve(routeInfo);},function(gipErr){console.error('Error in error page `getInitialProps`: ',gipErr);routeInfo.error=err;routeInfo.props={};resolve(routeInfo);});});}));});});}},{key:\"set\",value:function set(route,pathname,query,as,data){this.route=route;this.pathname=pathname;this.query=query;this.asPath=as;this.notify(data);}},{key:\"beforePopState\",value:function beforePopState(cb){this._bps=cb;}},{key:\"onlyAHashChange\",value:function onlyAHashChange(as){if(!this.asPath)return false;var _this$asPath$split=this.asPath.split('#'),_this$asPath$split2=(0,_slicedToArray2.default)(_this$asPath$split,2),oldUrlNoHash=_this$asPath$split2[0],oldHash=_this$asPath$split2[1];var _as$split=as.split('#'),_as$split2=(0,_slicedToArray2.default)(_as$split,2),newUrlNoHash=_as$split2[0],newHash=_as$split2[1];if(newHash&&oldUrlNoHash===newUrlNoHash&&oldHash===newHash){return true;}if(oldUrlNoHash!==newUrlNoHash){return false;}return oldHash!==newHash;}},{key:\"scrollToHash\",value:function scrollToHash(as){var _as$split3=as.split('#'),_as$split4=(0,_slicedToArray2.default)(_as$split3,2),hash=_as$split4[1];if(hash===''){window.scrollTo(0,0);return;}var idEl=document.getElementById(hash);if(idEl){idEl.scrollIntoView();return;}var nameEl=document.getElementsByName(hash)[0];if(nameEl){nameEl.scrollIntoView();}}},{key:\"urlIsNew\",value:function urlIsNew(asPath){return this.asPath!==asPath;}},{key:\"prefetch\",value:function prefetch(url){var _this4=this;return new Promise(function(resolve,reject){var _url_1$parse3=url_1.parse(url),pathname=_url_1$parse3.pathname,protocol=_url_1$parse3.protocol;if(!pathname||protocol){if(process.env.NODE_ENV!=='production'){throw new Error(\"Invalid href passed to router: \"+url+\" https://err.sh/zeit/next.js/invalid-href-passed\");}return;}if(process.env.NODE_ENV!=='production')return;var route=toRoute(pathname);_this4.pageLoader.prefetch(route).then(resolve,reject);});}},{key:\"fetchComponent\",value:function fetchComponent(route){var cancelled,cancel,Component,error;return _regenerator.default.async(function fetchComponent$(_context){while(1){switch(_context.prev=_context.next){case 0:cancelled=false;cancel=this.clc=function(){cancelled=true;};_context.next=4;return _regenerator.default.awrap(this.pageLoader.loadPage(route));case 4:Component=_context.sent;if(!cancelled){_context.next=9;break;}error=new Error(\"Abort fetching component for route: \\\"\"+route+\"\\\"\");error.cancelled=true;throw error;case 9:if(cancel===this.clc){this.clc=null;}return _context.abrupt(\"return\",Component);case 11:case\"end\":return _context.stop();}}},null,this);}},{key:\"getInitialProps\",value:function getInitialProps(Component,ctx){var cancelled,cancel,App,props,status,_url_1$parse4,pathname,AppTree,err;return _regenerator.default.async(function getInitialProps$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:cancelled=false;cancel=function cancel(){cancelled=true;};this.clc=cancel;App=this.components['/_app'].Component;if(!((self.__HAS_SPR||process.env.NODE_ENV!=='production')&&Component.__NEXT_SPR)){_context2.next=11;break;}_url_1$parse4=url_1.parse(ctx.asPath||ctx.pathname),pathname=_url_1$parse4.pathname;_context2.next=8;return _regenerator.default.awrap(fetch(\"/_next/data\"+pathname+\".json\").then(function(res){if(!res.ok){status=res.status;throw new Error('failed to load prerender data');}return res.json();}).catch(function(err){console.error(\"Failed to load data\",status,err);window.location.href=pathname;return new Promise(function(){});}));case 8:props=_context2.sent;_context2.next=16;break;case 11:AppTree=this._wrapApp(App);ctx.AppTree=AppTree;_context2.next=15;return _regenerator.default.awrap(utils_1.loadGetInitialProps(App,{AppTree:AppTree,Component:Component,router:this,ctx:ctx}));case 15:props=_context2.sent;case 16:if(cancel===this.clc){this.clc=null;}if(!cancelled){_context2.next=21;break;}err=new Error('Loading initial props cancelled');err.cancelled=true;throw err;case 21:return _context2.abrupt(\"return\",props);case 22:case\"end\":return _context2.stop();}}},null,this);}},{key:\"abortComponentLoad\",value:function abortComponentLoad(as){if(this.clc){var e=new Error('Route Cancelled');e.cancelled=true;Router.events.emit('routeChangeError',e,as);this.clc();this.clc=null;}}},{key:\"notify\",value:function notify(data){this.sub(data,this.components['/_app'].Component);}}],[{key:\"_rewriteUrlForNextExport\",value:function _rewriteUrlForNextExport(url){return rewrite_url_for_export_1.rewriteUrlForNextExport(url);}}]);return Router;}();Router.events=mitt_1.default();exports.default=Router;","map":null,"metadata":{},"sourceType":"script"}