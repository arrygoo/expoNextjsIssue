{"ast":null,"code":"\"use strict\";var _interopRequireDefault2=require(\"@babel/runtime/helpers/interopRequireDefault\");var _regenerator=_interopRequireDefault2(require(\"@babel/runtime/regenerator\"));var _classCallCheck2=_interopRequireDefault2(require(\"@babel/runtime/helpers/classCallCheck\"));var _createClass2=_interopRequireDefault2(require(\"@babel/runtime/helpers/createClass\"));var _interopRequireDefault=require(\"@babel/runtime-corejs2/helpers/interopRequireDefault\");exports.__esModule=true;exports.default=void 0;var _asyncToGenerator2=_interopRequireDefault(require(\"@babel/runtime-corejs2/helpers/asyncToGenerator\"));var _promise=_interopRequireDefault(require(\"@babel/runtime-corejs2/core-js/promise\"));var _mitt=_interopRequireDefault(require(\"../next-server/lib/mitt\"));function supportsPreload(el){try{return el.relList.supports('preload');}catch(_unused){return false;}}var hasPreload=supportsPreload(document.createElement('link'));function preloadScript(url){var link=document.createElement('link');link.rel='preload';link.crossOrigin=process.crossOrigin;link.href=encodeURI(url);link.as='script';document.head.appendChild(link);}var PageLoader=function(){function PageLoader(buildId,assetPrefix){(0,_classCallCheck2.default)(this,PageLoader);this.buildId=buildId;this.assetPrefix=assetPrefix;this.pageCache={};this.pageRegisterEvents=(0,_mitt.default)();this.loadingRoutes={};if(process.env.__NEXT_GRANULAR_CHUNKS){this.promisedBuildManifest=new _promise.default(function(resolve){if(window.__BUILD_MANIFEST){resolve(window.__BUILD_MANIFEST);}else{window.__BUILD_MANIFEST_CB=function(){resolve(window.__BUILD_MANIFEST);};}});}}(0,_createClass2.default)(PageLoader,[{key:\"getDependencies\",value:function getDependencies(route){return this.promisedBuildManifest.then(function(man){return man[route]&&man[route].map(function(url){return\"/_next/\"+url;})||[];});}},{key:\"normalizeRoute\",value:function normalizeRoute(route){if(route[0]!=='/'){throw new Error(\"Route name should start with a \\\"/\\\", got \\\"\"+route+\"\\\"\");}route=route.replace(/\\/index$/,'/');if(route==='/')return route;return route.replace(/\\/$/,'');}},{key:\"loadPage\",value:function loadPage(route){var _this3=this;route=this.normalizeRoute(route);return new _promise.default(function(resolve,reject){var fire=function fire(_ref){var error=_ref.error,page=_ref.page;_this3.pageRegisterEvents.off(route,fire);delete _this3.loadingRoutes[route];if(error){reject(error);}else{resolve(page);}};var cachedPage=_this3.pageCache[route];if(cachedPage){var error=cachedPage.error,page=cachedPage.page;error?reject(error):resolve(page);return;}_this3.pageRegisterEvents.on(route,fire);if(document.querySelector(\"script[data-next-page=\\\"\"+route+\"\\\"]\")){return;}if(!_this3.loadingRoutes[route]){if(process.env.__NEXT_GRANULAR_CHUNKS){_this3.getDependencies(route).then(function(deps){deps.forEach(function(d){if(!document.querySelector(\"script[src^=\\\"\"+d+\"\\\"]\")){_this3.loadScript(d,route,false);}});_this3.loadRoute(route);_this3.loadingRoutes[route]=true;});}else{_this3.loadRoute(route);_this3.loadingRoutes[route]=true;}}});}},{key:\"loadRoute\",value:function loadRoute(route){var _this=this;return(0,_asyncToGenerator2.default)(_regenerator.default.mark(function _callee(){var scriptRoute,url;return _regenerator.default.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:route=_this.normalizeRoute(route);scriptRoute=route==='/'?'/index.js':route+\".js\";url=_this.assetPrefix+\"/_next/static/\"+encodeURIComponent(_this.buildId)+\"/pages\"+scriptRoute;_this.loadScript(url,route,true);case 4:case\"end\":return _context.stop();}}},_callee);}))();}},{key:\"loadScript\",value:function loadScript(url,route,isPage){var _this4=this;var script=document.createElement('script');if(process.env.__NEXT_MODERN_BUILD&&'noModule'in script){script.type='module';if(isPage)url=url.replace(/\\.js$/,'.module.js');}script.crossOrigin=process.crossOrigin;script.src=encodeURI(url);script.onerror=function(){var error=new Error(\"Error loading script \"+url);error.code='PAGE_LOAD_ERROR';_this4.pageRegisterEvents.emit(route,{error:error});};document.body.appendChild(script);}},{key:\"registerPage\",value:function registerPage(route,regFn){var _this5=this;var register=function register(){try{var mod=regFn();var pageData={page:mod.default||mod,mod:mod};_this5.pageCache[route]=pageData;_this5.pageRegisterEvents.emit(route,pageData);}catch(error){_this5.pageCache[route]={error:error};_this5.pageRegisterEvents.emit(route,{error:error});}};if(process.env.NODE_ENV!=='production'){if(module.hot&&module.hot.status()!=='idle'){console.log(\"Waiting for webpack to become \\\"idle\\\" to initialize the page: \\\"\"+route+\"\\\"\");var check=function check(status){if(status==='idle'){module.hot.removeStatusHandler(check);register();}};module.hot.status(check);return;}}register();}},{key:\"prefetch\",value:function prefetch(route,isDependency){var _this2=this;return(0,_asyncToGenerator2.default)(_regenerator.default.mark(function _callee2(){var scriptRoute,url,cn;return _regenerator.default.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:route=_this2.normalizeRoute(route);scriptRoute=(route==='/'?'/index':route)+\".js\";if(process.env.__NEXT_MODERN_BUILD&&'noModule'in document.createElement('script')){scriptRoute=scriptRoute.replace(/\\.js$/,'.module.js');}url=isDependency?route:_this2.assetPrefix+\"/_next/static/\"+encodeURIComponent(_this2.buildId)+\"/pages\"+scriptRoute;if(!document.querySelector(\"link[rel=\\\"preload\\\"][href^=\\\"\"+url+\"\\\"], script[data-next-page=\\\"\"+route+\"\\\"]\")){_context2.next=6;break;}return _context2.abrupt(\"return\");case 6:if(!(cn=navigator.connection)){_context2.next=9;break;}if(!((cn.effectiveType||'').indexOf('2g')!==-1||cn.saveData)){_context2.next=9;break;}return _context2.abrupt(\"return\");case 9:if(!(process.env.__NEXT_GRANULAR_CHUNKS&&!isDependency)){_context2.next=15;break;};_context2.next=13;return _this2.getDependencies(route);case 13:_context2.t0=function(url){_this2.prefetch(url,true);};_context2.sent.forEach(_context2.t0);case 15:if(!hasPreload){_context2.next=18;break;}preloadScript(url);return _context2.abrupt(\"return\");case 18:if(!isDependency){_context2.next=20;break;}return _context2.abrupt(\"return\");case 20:if(!(document.readyState==='complete')){_context2.next=24;break;}return _context2.abrupt(\"return\",_this2.loadPage(route).catch(function(){}));case 24:return _context2.abrupt(\"return\",new _promise.default(function(resolve){window.addEventListener('load',function(){_this2.loadPage(route).then(function(){return resolve();},function(){return resolve();});});}));case 25:case\"end\":return _context2.stop();}}},_callee2);}))();}}]);return PageLoader;}();exports.default=PageLoader;","map":null,"metadata":{},"sourceType":"script"}